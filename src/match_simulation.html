<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulação de Partida - ValSim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        body { background-color: #0f172a; color: #FAFAFA; display: flex; flex-direction: column; }
        .card-custom { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; }
        .font-headline { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; border: none; }
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-disabled { cursor: not-allowed; background-color: #4b5563; }
        .kill-feed-item { display: flex; align-items: center; justify-content: space-between; background-color: rgba(51, 65, 85, 0.5); border-radius: 0.375rem; padding: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; animation: fadeIn 0.5s; }
        .team-a-text { color: #60A5FA; }
        .team-b-text { color: #F87171; }
        #match-simulation-container { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 1rem 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4">

    <div id="loading-screen" class="fixed inset-0 bg-slate-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="text-center"><p class="text-xl">Carregando dados da partida...</p></div>
    </div>
    <div id="post-match-screen" class="hidden fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-40 p-4"></div>

    <main id="match-simulation-container" class="hidden w-full max-w-7xl mx-auto">
        
        <header class="flex-shrink-0">
            <div class="card-custom p-3 flex justify-between items-center">
                <a href="/quick_match" class="text-gray-400 hover:text-white text-sm">&larr; Nova Simulação</a>
                <div id="series-info" class="text-center">
                    <h2 class="text-sm text-gray-400">Placar da Série (MD<span id="series-format"></span>)</h2>
                    <p class="text-base">Mapa <span id="map-number">1</span> de <span id="total-maps">1</span>: <span id="map-name" class="font-bold"></span></p>
                </div>
                <div class="text-sm w-28 text-right"></div>
            </div>
            <section class="grid grid-cols-3 gap-4 text-center items-center mt-4">
                <div class="card-custom p-4"><h3 id="team-a-name-series" class="text-lg font-bold">Time A</h3><p id="series-score-a" class="text-4xl font-headline">0</p></div>
                <div class="card-custom p-4 flex justify-around items-center text-center">
                     <div><p id="team-a-role" class="text-sm team-a-text font-bold"></p><p id="map-score-a" class="text-5xl font-bold">0</p></div>
                     <div><h3 class="text-2xl font-bold">Round <span id="round-number">1</span></h3><p id="overtime-indicator" class="text-yellow-400 hidden">OVERTIME</p></div>
                     <div><p id="team-b-role" class="text-sm team-b-text font-bold"></p><p id="map-score-b" class="text-5xl font-bold">0</p></div>
                </div>
                <div class="card-custom p-4"><h3 id="team-b-name-series" class="text-lg font-bold">Time B</h3><p id="series-score-b" class="text-4xl font-headline">0</p></div>
            </section>
        </header>

        <div class="main-content">
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
                <div class="card-custom p-4"><h3 id="team-a-name-stats" class="text-xl font-bold mb-2"></h3><table class="w-full text-sm"><thead><tr class="text-left text-gray-400"><th class="p-1">Jogador</th><th class="p-1 text-center">K</th><th class="p-1 text-center">D</th><th class="p-1 text-center">ACS</th></tr></thead><tbody id="team-a-stats-body"></tbody></table></div>
                <div class="card-custom p-4"><h3 class="text-xl font-bold mb-2 text-center">Feed de Abates</h3><div id="kill-feed" class="h-full overflow-y-auto"></div></div>
                <div class="card-custom p-4"><h3 id="team-b-name-stats" class="text-xl font-bold mb-2"></h3><table class="w-full text-sm"><thead><tr class="text-left text-gray-400"><th class="p-1">Jogador</th><th class="p-1 text-center">K</th><th class="p-1 text-center">D</th><th class="p-1 text-center">ACS</th></tr></thead><tbody id="team-b-stats-body"></tbody></table></div>
            </section>
        </div>

        <footer class="flex-shrink-0 mt-4">
            <div id="simulation-controls" class="card-custom p-3 flex justify-center items-center gap-4">
                <button id="sim-round-btn" class="btn btn-blue">Simular Round</button>
                <button id="sim-map-btn" class="btn btn-blue">Simular até o Fim do Mapa</button>
                <button id="sim-series-btn" class="btn btn-blue">Simular Série Inteira</button>
            </div>
        </footer>
    </main>

    <script type="module">
        const UI = {
            // ... (elementos DOM) ...
            loadingScreen: document.getElementById('loading-screen'),
            container: document.getElementById('match-simulation-container'),
            postMatchScreen: document.getElementById('post-match-screen'),
            teamANameSeries: document.getElementById('team-a-name-series'),
            teamBNameSeries: document.getElementById('team-b-name-series'),
            seriesScoreA: document.getElementById('series-score-a'),
            seriesScoreB: document.getElementById('series-score-b'),
            mapScoreA: document.getElementById('map-score-a'),
            mapScoreB: document.getElementById('map-score-b'),
            roundNumber: document.getElementById('round-number'),
            overtimeIndicator: document.getElementById('overtime-indicator'),
            seriesFormat: document.getElementById('series-format'),
            mapNumber: document.getElementById('map-number'),
            totalMaps: document.getElementById('total-maps'),
            mapName: document.getElementById('map-name'),
            teamARole: document.getElementById('team-a-role'),
            teamBRole: document.getElementById('team-b-role'),
            teamANameStats: document.getElementById('team-a-name-stats'),
            teamBNameStats: document.getElementById('team-b-name-stats'),
            teamAStatsBody: document.getElementById('team-a-stats-body'),
            teamBStatsBody: document.getElementById('team-b-stats-body'),
            killFeed: document.getElementById('kill-feed'),
            simRoundBtn: document.getElementById('sim-round-btn'),
            simMapBtn: document.getElementById('sim-map-btn'),
            simSeriesBtn: document.getElementById('sim-series-btn'),

            update(state) {
                if (!state) return; // Guarda de segurança
                this.teamANameSeries.textContent = state.teamA.name;
                this.teamBNameSeries.textContent = state.teamB.name;
                this.teamANameStats.textContent = state.teamA.name;
                this.teamBNameStats.textContent = state.teamB.name;
                this.seriesScoreA.textContent = state.seriesScoreA;
                this.seriesScoreB.textContent = state.seriesScoreB;
                this.mapScoreA.textContent = state.mapScoreA;
                this.mapScoreB.textContent = state.mapScoreB;
                this.roundNumber.textContent = state.roundNumber;
                this.overtimeIndicator.classList.toggle('hidden', !state.isOvertime);
                this.seriesFormat.textContent = state.format.replace('md','');
                this.totalMaps.textContent = state.maps.length;
                this.mapNumber.textContent = state.currentMapIndex + 1;
                this.mapName.textContent = state.maps[state.currentMapIndex].charAt(0).toUpperCase() + state.maps[state.currentMapIndex].slice(1);
                this.teamARole.textContent = state.teamARole;
                this.teamBRole.textContent = state.teamBRole;
                this.renderPlayerStats(this.teamAStatsBody, state.teamAPlayers);
                this.renderPlayerStats(this.teamBStatsBody, state.teamBPlayers);
            },

            renderPlayerStats(tbody, players) {
                tbody.innerHTML = players.map(p => `
                    <tr class="${!p.is_alive ? 'opacity-50' : ''}">
                        <td class="p-1 font-medium ${!p.is_alive ? 'line-through' : ''}">${p.name}</td>
                        <td class="p-1 text-center">${p.stats.kills}</td>
                        <td class="p-1 text-center">${p.stats.deaths}</td>
                        <td class="p-1 text-center">${Math.round(p.stats.acs)}</td>
                    </tr>
                `).join('');
            },

            renderKillFeed(event) {
                const { killer_name, victim_name, killer_team_id, victim_team_id } = event.data;
                const killerClass = killer_team_id === window.simulationState.teamA.id ? 'team-a-text' : 'team-b-text';
                const victimClass = victim_team_id === window.simulationState.teamA.id ? 'team-a-text' : 'team-b-text'; // Corrigido
                const item = document.createElement('div');
                item.className = 'kill-feed-item';
                item.innerHTML = `<span class="font-bold ${killerClass}">${killer_name}</span> <span class="text-gray-400">eliminou</span> <span class="font-bold ${victimClass}">${victim_name}</span>`;
                this.killFeed.prepend(item);
            },

            showPostMatchScreen(state) {
                const winningTeamName = state.seriesScoreA > state.seriesScoreB ? state.teamA.name : state.teamB.name;
                this.postMatchScreen.innerHTML = `
                    <div class="card-custom p-8 text-center max-w-2xl mx-auto">
                        <h2 class="text-4xl font-headline mb-2">Partida Encerrada</h2>
                        <p class="text-lg mb-4"><span class="font-bold text-yellow-400">${winningTeamName}</span> venceu a série!</p>
                        <div class="text-5xl font-headline mb-6">${state.seriesScoreA} - ${state.seriesScoreB}</div>
                        <a href="/quick_match" class="btn btn-blue">Jogar Novamente</a>
                    </div>`;
                this.postMatchScreen.style.display = 'flex';
                this.container.style.display = 'none';
            },

            setControlsState(enabled) {
                this.simRoundBtn.disabled = !enabled;
                this.simMapBtn.disabled = !enabled;
                this.simSeriesBtn.disabled = !enabled;
                this.simRoundBtn.classList.toggle('btn-disabled', !enabled);
                this.simMapBtn.classList.toggle('btn-disabled', !enabled);
                this.simSeriesBtn.classList.toggle('btn-disabled', !enabled);
            }
        };

        class SimulationController {
            constructor() {
                this.params = new URLSearchParams(window.location.search);
                this.eventGenerator = null;
                this.isAutoSimulating = false;
                this.autoSimMode = 'none';
            }

            async initialize() {
                if (!this.params.has('teamA') || !this.params.has('teamB')) {
                    UI.loadingScreen.innerHTML = `<div class="text-red-500">Parâmetros inválidos.</div>`;
                    return;
                }
                const response = await fetch(`/api/simulate_series?${this.params.toString()}`);
                if (!response.ok) {
                    UI.loadingScreen.innerHTML = `<div class="text-red-500">Erro: ${response.statusText}</div>`;
                    return;
                }
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                const eventIterator = (async function*() {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        for (const line of lines) { if (line.trim()) yield JSON.parse(line); }
                    }
                })();
                this.eventGenerator = eventIterator;
                this.setupEventListeners();
                const firstEvent = await this.eventGenerator.next();
                if (firstEvent.value) {
                    this.handleEvent(firstEvent.value);
                    UI.loadingScreen.style.display = 'none';
                    UI.container.style.display = 'flex';
                }
            }
            
            setupEventListeners() {
                UI.simRoundBtn.onclick = () => this.startAutoSim('round');
                UI.simMapBtn.onclick = () => this.startAutoSim('map');
                UI.simSeriesBtn.onclick = () => this.startAutoSim('series');
            }

            handleEvent(event) {
                // SÓ atualiza o state global se o evento tiver um
                if (event.state) {
                    window.simulationState = event.state;
                }

                // Decide o que renderizar baseado no tipo de evento
                if (event.type === 'kill') {
                    UI.renderKillFeed(event);
                    // Atualiza apenas as estatísticas dos jogadores, que mudam com abates
                    UI.renderPlayerStats(UI.teamAStatsBody, window.simulationState.teamAPlayers);
                    UI.renderPlayerStats(UI.teamBStatsBody, window.simulationState.teamBPlayers);
                } else {
                    // Para outros tipos de evento (round_end, map_end etc), faz um update completo
                    UI.update(window.simulationState);
                }
                
                if (event.type === 'series_end') {
                    UI.showPostMatchScreen(window.simulationState);
                    this.isAutoSimulating = false;
                }
            }

            async startAutoSim(mode) {
                if (this.isAutoSimulating) return;
                this.isAutoSimulating = true;
                this.autoSimMode = mode;
                UI.setControlsState(false);
                await this.runSimulationLoop();
                UI.setControls-State(true);
                this.isAutoSimulating = false;
            }
            
            async runSimulationLoop() {
                let lastRound = window.simulationState.roundNumber;
                let lastMap = window.simulationState.currentMapIndex;

                for await (const event of this.eventGenerator) {
                    this.handleEvent(event);
                    
                    const currentState = window.simulationState;
                    if (this.autoSimMode === 'round' && event.type === 'round_end' && currentState.roundNumber !== lastRound) break; 
                    if (this.autoSimMode === 'map' && event.type === 'map_end' && currentState.currentMapIndex !== lastMap) break;
                    if (event.type === 'series_end') break;
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const controller = new SimulationController();
            controller.initialize();
        });
    </script>
</body>
</html>
